# 📨 消息格式文档

## Popup ↔ Background 消息协议

### 支持的消息类型

| 消息类型 | 发送方 | 接收方 | 用途 |
|---------|-------|-------|------|
| `GET_INIT_STATUS` | Popup | Background | 检查初始化状态 |
| `INITIALIZE_ENGINE` | Popup | Background | 启动初始化 |
| `SEARCH_BOOKMARKS` | Popup | Background | 执行搜索 |
| `GET_INIT_PROGRESS` | Popup | Background | 获取初始化进度 |

---

## 1. GET_INIT_STATUS

### 请求
```javascript
{
  type: 'GET_INIT_STATUS'
}
```

### 响应
```javascript
{
  success: true,
  isInitialized: boolean,  // 是否已初始化
  progress: {              // 当前进度
    current: number,
    total: number,
    status: string
  }
}
```

### 用途
- Popup 打开时首先检查状态
- 判断是否需要初始化
- 判断是否正在初始化中

---

## 2. INITIALIZE_ENGINE

### 请求
```javascript
{
  type: 'INITIALIZE_ENGINE'
}
```

### 响应
```javascript
{
  success: true  // 初始化成功
}
// 或
{
  success: false,
  error: string  // 错误信息
}
```

### 用途
- 启动语义搜索引擎初始化
- 首次使用时调用
- 可能需要 3-5 分钟

---

## 3. SEARCH_BOOKMARKS

### 请求
```javascript
{
  type: 'SEARCH_BOOKMARKS',
  query: string,    // 搜索查询
  topK: number      // 返回结果数量（可选，默认 20）
}
```

### 响应
```javascript
{
  success: true,
  results: [
    {
      id: string,
      title: string,
      url: string,
      score: number,    // 相似度分数 (0-1)
      dateAdded: number
    },
    // ... 更多结果
  ]
}
// 或
{
  success: false,
  error: string
}
```

### 用途
- 执行语义搜索
- 返回按相似度排序的书签

---

## 4. GET_INIT_PROGRESS

### 请求
```javascript
{
  type: 'GET_INIT_PROGRESS'
}
```

### 响应
```javascript
{
  success: true,
  progress: {
    current: number,        // 当前进度
    total: number,          // 总数
    status: string          // 状态描述
  }
}
```

### 状态值
- `'ready'` - 就绪，未开始
- `'loading_model'` - 加载模型中
- `'loading_bookmarks'` - 加载书签中
- `'building_index'` - 构建索引中
- `'downloading_model_XX'` - 下载模型 XX%
- `'completed'` - 完成
- `'error'` - 错误

### 用途
- 显示初始化进度
- 轮询获取实时进度

---

## Background ↔ Offscreen 消息协议

### 支持的消息类型

| 消息类型 | 发送方 | 接收方 | 用途 |
|---------|-------|-------|------|
| `OFFSCREEN_INITIALIZE` | Background | Offscreen | 初始化模型 |
| `OFFSCREEN_EMBED_TEXT` | Background | Offscreen | 编码单个文本 |
| `OFFSCREEN_EMBED_BATCH` | Background | Offscreen | 批量编码文本 |
| `OFFSCREEN_STATUS` | Background | Offscreen | 检查状态 |
| `MODEL_PROGRESS` | Offscreen | Background | 模型下载进度 |
| `EMBED_PROGRESS` | Offscreen | Background | 编码进度 |

---

## 5. OFFSCREEN_INITIALIZE

### 请求
```javascript
{
  type: 'OFFSCREEN_INITIALIZE'
}
```

### 响应
```javascript
{
  success: true
}
// 或
{
  success: false,
  error: string
}
```

---

## 6. OFFSCREEN_EMBED_TEXT

### 请求
```javascript
{
  type: 'OFFSCREEN_EMBED_TEXT',
  text: string  // 要编码的文本
}
```

### 响应
```javascript
{
  success: true,
  embedding: number[]  // 384维向量
}
// 或
{
  success: false,
  error: string
}
```

---

## 7. OFFSCREEN_EMBED_BATCH

### 请求
```javascript
{
  type: 'OFFSCREEN_EMBED_BATCH',
  texts: string[]  // 要批量编码的文本数组
}
```

### 响应
```javascript
{
  success: true,
  embeddings: number[][]  // 384维向量数组
}
// 或
{
  success: false,
  error: string
}
```

---

## 8. MODEL_PROGRESS (主动推送)

### 消息
```javascript
{
  type: 'MODEL_PROGRESS',
  progress: number  // 0-100
}
```

### 用途
- Offscreen 主动推送模型下载进度
- Background 接收并可能转发给 Popup

---

## 9. EMBED_PROGRESS (主动推送)

### 消息
```javascript
{
  type: 'EMBED_PROGRESS',
  current: number,  // 当前进度
  total: number     // 总数
}
```

### 用途
- Offscreen 主动推送编码进度
- Background 接收并可能转发给 Popup

---

## 代码示例

### Popup 发送消息
```javascript
// 封装的消息发送方法
async sendMessage(message) {
  return new Promise((resolve, reject) => {
    chrome.runtime.sendMessage(message, (response) => {
      if (chrome.runtime.lastError) {
        reject(chrome.runtime.lastError);
      } else {
        resolve(response);
      }
    });
  });
}

// 使用
const response = await this.sendMessage({
  type: 'SEARCH_BOOKMARKS',
  query: '排解忧虑',
  topK: 20
});

if (response.success) {
  console.log('搜索结果:', response.results);
}
```

### Background 监听消息
```javascript
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  const messageType = request.type || request.action;

  if (messageType === 'SEARCH_BOOKMARKS') {
    searchEngine.searchBookmarks(request.query, request.topK)
      .then(results => {
        sendResponse({ success: true, results });
      })
      .catch(error => {
        sendResponse({ success: false, error: error.message });
      });
    return true; // 异步响应
  }
});
```

### Offscreen 监听消息
```javascript
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.type === 'OFFSCREEN_EMBED_TEXT') {
    engine.embedText(message.text)
      .then(embedding => {
        sendResponse({ success: true, embedding });
      })
      .catch(error => {
        sendResponse({ success: false, error: error.message });
      });
    return true; // 异步响应
  }
});
```

---

## 注意事项

### 1. 异步响应
如果消息处理是异步的，必须 `return true`:
```javascript
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  // 异步操作
  someAsyncFunction().then(result => {
    sendResponse({ success: true, result });
  });
  
  return true; // 关键！
});
```

### 2. 错误处理
总是检查 `chrome.runtime.lastError`:
```javascript
chrome.runtime.sendMessage(message, (response) => {
  if (chrome.runtime.lastError) {
    console.error('发送消息失败:', chrome.runtime.lastError);
    return;
  }
  // 处理响应
});
```

### 3. 兼容性
`background_offscreen.js` 同时支持 `type` 和 `action` 字段：
```javascript
const messageType = request.type || request.action;
```

### 4. 超时处理
消息可能会超时，建议添加超时处理：
```javascript
async sendMessageWithTimeout(message, timeout = 30000) {
  return Promise.race([
    this.sendMessage(message),
    new Promise((_, reject) => 
      setTimeout(() => reject(new Error('Timeout')), timeout)
    )
  ]);
}
```

---

## 调试技巧

### 1. 查看 Service Worker 日志
```
chrome://extensions/ → service worker → Console
```

### 2. 查看 Popup 日志
```
右键点击扩展图标 → 审查弹出内容 → Console
```

### 3. 查看 Offscreen Document 日志
```
chrome://extensions/ → 
在 Service Worker Console 中查找 Offscreen Document 的 iframe
```

### 4. 添加详细日志
```javascript
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  console.log('📨 收到消息:', {
    type: request.type,
    from: sender.tab ? 'content' : 'popup',
    data: request
  });
  
  // ... 处理消息
  
  console.log('📤 发送响应:', response);
  sendResponse(response);
});
```

---

## 总结

✅ 所有消息类型已统一  
✅ Popup ↔ Background 通信正常  
✅ Background ↔ Offscreen 通信正常  
✅ 支持异步响应  
✅ 完善的错误处理  

**现在重新加载扩展，应该可以正常搜索了！** 🎉

