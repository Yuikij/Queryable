# ğŸ“¨ æ¶ˆæ¯æ ¼å¼æ–‡æ¡£

## Popup â†” Background æ¶ˆæ¯åè®®

### æ”¯æŒçš„æ¶ˆæ¯ç±»å‹

| æ¶ˆæ¯ç±»å‹ | å‘é€æ–¹ | æ¥æ”¶æ–¹ | ç”¨é€” |
|---------|-------|-------|------|
| `GET_INIT_STATUS` | Popup | Background | æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€ |
| `INITIALIZE_ENGINE` | Popup | Background | å¯åŠ¨åˆå§‹åŒ– |
| `SEARCH_BOOKMARKS` | Popup | Background | æ‰§è¡Œæœç´¢ |
| `GET_INIT_PROGRESS` | Popup | Background | è·å–åˆå§‹åŒ–è¿›åº¦ |

---

## 1. GET_INIT_STATUS

### è¯·æ±‚
```javascript
{
  type: 'GET_INIT_STATUS'
}
```

### å“åº”
```javascript
{
  success: true,
  isInitialized: boolean,  // æ˜¯å¦å·²åˆå§‹åŒ–
  progress: {              // å½“å‰è¿›åº¦
    current: number,
    total: number,
    status: string
  }
}
```

### ç”¨é€”
- Popup æ‰“å¼€æ—¶é¦–å…ˆæ£€æŸ¥çŠ¶æ€
- åˆ¤æ–­æ˜¯å¦éœ€è¦åˆå§‹åŒ–
- åˆ¤æ–­æ˜¯å¦æ­£åœ¨åˆå§‹åŒ–ä¸­

---

## 2. INITIALIZE_ENGINE

### è¯·æ±‚
```javascript
{
  type: 'INITIALIZE_ENGINE'
}
```

### å“åº”
```javascript
{
  success: true  // åˆå§‹åŒ–æˆåŠŸ
}
// æˆ–
{
  success: false,
  error: string  // é”™è¯¯ä¿¡æ¯
}
```

### ç”¨é€”
- å¯åŠ¨è¯­ä¹‰æœç´¢å¼•æ“åˆå§‹åŒ–
- é¦–æ¬¡ä½¿ç”¨æ—¶è°ƒç”¨
- å¯èƒ½éœ€è¦ 3-5 åˆ†é’Ÿ

---

## 3. SEARCH_BOOKMARKS

### è¯·æ±‚
```javascript
{
  type: 'SEARCH_BOOKMARKS',
  query: string,    // æœç´¢æŸ¥è¯¢
  topK: number      // è¿”å›ç»“æœæ•°é‡ï¼ˆå¯é€‰ï¼Œé»˜è®¤ 20ï¼‰
}
```

### å“åº”
```javascript
{
  success: true,
  results: [
    {
      id: string,
      title: string,
      url: string,
      score: number,    // ç›¸ä¼¼åº¦åˆ†æ•° (0-1)
      dateAdded: number
    },
    // ... æ›´å¤šç»“æœ
  ]
}
// æˆ–
{
  success: false,
  error: string
}
```

### ç”¨é€”
- æ‰§è¡Œè¯­ä¹‰æœç´¢
- è¿”å›æŒ‰ç›¸ä¼¼åº¦æ’åºçš„ä¹¦ç­¾

---

## 4. GET_INIT_PROGRESS

### è¯·æ±‚
```javascript
{
  type: 'GET_INIT_PROGRESS'
}
```

### å“åº”
```javascript
{
  success: true,
  progress: {
    current: number,        // å½“å‰è¿›åº¦
    total: number,          // æ€»æ•°
    status: string          // çŠ¶æ€æè¿°
  }
}
```

### çŠ¶æ€å€¼
- `'ready'` - å°±ç»ªï¼Œæœªå¼€å§‹
- `'loading_model'` - åŠ è½½æ¨¡å‹ä¸­
- `'loading_bookmarks'` - åŠ è½½ä¹¦ç­¾ä¸­
- `'building_index'` - æ„å»ºç´¢å¼•ä¸­
- `'downloading_model_XX'` - ä¸‹è½½æ¨¡å‹ XX%
- `'completed'` - å®Œæˆ
- `'error'` - é”™è¯¯

### ç”¨é€”
- æ˜¾ç¤ºåˆå§‹åŒ–è¿›åº¦
- è½®è¯¢è·å–å®æ—¶è¿›åº¦

---

## Background â†” Offscreen æ¶ˆæ¯åè®®

### æ”¯æŒçš„æ¶ˆæ¯ç±»å‹

| æ¶ˆæ¯ç±»å‹ | å‘é€æ–¹ | æ¥æ”¶æ–¹ | ç”¨é€” |
|---------|-------|-------|------|
| `OFFSCREEN_INITIALIZE` | Background | Offscreen | åˆå§‹åŒ–æ¨¡å‹ |
| `OFFSCREEN_EMBED_TEXT` | Background | Offscreen | ç¼–ç å•ä¸ªæ–‡æœ¬ |
| `OFFSCREEN_EMBED_BATCH` | Background | Offscreen | æ‰¹é‡ç¼–ç æ–‡æœ¬ |
| `OFFSCREEN_STATUS` | Background | Offscreen | æ£€æŸ¥çŠ¶æ€ |
| `MODEL_PROGRESS` | Offscreen | Background | æ¨¡å‹ä¸‹è½½è¿›åº¦ |
| `EMBED_PROGRESS` | Offscreen | Background | ç¼–ç è¿›åº¦ |

---

## 5. OFFSCREEN_INITIALIZE

### è¯·æ±‚
```javascript
{
  type: 'OFFSCREEN_INITIALIZE'
}
```

### å“åº”
```javascript
{
  success: true
}
// æˆ–
{
  success: false,
  error: string
}
```

---

## 6. OFFSCREEN_EMBED_TEXT

### è¯·æ±‚
```javascript
{
  type: 'OFFSCREEN_EMBED_TEXT',
  text: string  // è¦ç¼–ç çš„æ–‡æœ¬
}
```

### å“åº”
```javascript
{
  success: true,
  embedding: number[]  // 384ç»´å‘é‡
}
// æˆ–
{
  success: false,
  error: string
}
```

---

## 7. OFFSCREEN_EMBED_BATCH

### è¯·æ±‚
```javascript
{
  type: 'OFFSCREEN_EMBED_BATCH',
  texts: string[]  // è¦æ‰¹é‡ç¼–ç çš„æ–‡æœ¬æ•°ç»„
}
```

### å“åº”
```javascript
{
  success: true,
  embeddings: number[][]  // 384ç»´å‘é‡æ•°ç»„
}
// æˆ–
{
  success: false,
  error: string
}
```

---

## 8. MODEL_PROGRESS (ä¸»åŠ¨æ¨é€)

### æ¶ˆæ¯
```javascript
{
  type: 'MODEL_PROGRESS',
  progress: number  // 0-100
}
```

### ç”¨é€”
- Offscreen ä¸»åŠ¨æ¨é€æ¨¡å‹ä¸‹è½½è¿›åº¦
- Background æ¥æ”¶å¹¶å¯èƒ½è½¬å‘ç»™ Popup

---

## 9. EMBED_PROGRESS (ä¸»åŠ¨æ¨é€)

### æ¶ˆæ¯
```javascript
{
  type: 'EMBED_PROGRESS',
  current: number,  // å½“å‰è¿›åº¦
  total: number     // æ€»æ•°
}
```

### ç”¨é€”
- Offscreen ä¸»åŠ¨æ¨é€ç¼–ç è¿›åº¦
- Background æ¥æ”¶å¹¶å¯èƒ½è½¬å‘ç»™ Popup

---

## ä»£ç ç¤ºä¾‹

### Popup å‘é€æ¶ˆæ¯
```javascript
// å°è£…çš„æ¶ˆæ¯å‘é€æ–¹æ³•
async sendMessage(message) {
  return new Promise((resolve, reject) => {
    chrome.runtime.sendMessage(message, (response) => {
      if (chrome.runtime.lastError) {
        reject(chrome.runtime.lastError);
      } else {
        resolve(response);
      }
    });
  });
}

// ä½¿ç”¨
const response = await this.sendMessage({
  type: 'SEARCH_BOOKMARKS',
  query: 'æ’è§£å¿§è™‘',
  topK: 20
});

if (response.success) {
  console.log('æœç´¢ç»“æœ:', response.results);
}
```

### Background ç›‘å¬æ¶ˆæ¯
```javascript
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  const messageType = request.type || request.action;

  if (messageType === 'SEARCH_BOOKMARKS') {
    searchEngine.searchBookmarks(request.query, request.topK)
      .then(results => {
        sendResponse({ success: true, results });
      })
      .catch(error => {
        sendResponse({ success: false, error: error.message });
      });
    return true; // å¼‚æ­¥å“åº”
  }
});
```

### Offscreen ç›‘å¬æ¶ˆæ¯
```javascript
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.type === 'OFFSCREEN_EMBED_TEXT') {
    engine.embedText(message.text)
      .then(embedding => {
        sendResponse({ success: true, embedding });
      })
      .catch(error => {
        sendResponse({ success: false, error: error.message });
      });
    return true; // å¼‚æ­¥å“åº”
  }
});
```

---

## æ³¨æ„äº‹é¡¹

### 1. å¼‚æ­¥å“åº”
å¦‚æœæ¶ˆæ¯å¤„ç†æ˜¯å¼‚æ­¥çš„ï¼Œå¿…é¡» `return true`:
```javascript
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  // å¼‚æ­¥æ“ä½œ
  someAsyncFunction().then(result => {
    sendResponse({ success: true, result });
  });
  
  return true; // å…³é”®ï¼
});
```

### 2. é”™è¯¯å¤„ç†
æ€»æ˜¯æ£€æŸ¥ `chrome.runtime.lastError`:
```javascript
chrome.runtime.sendMessage(message, (response) => {
  if (chrome.runtime.lastError) {
    console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', chrome.runtime.lastError);
    return;
  }
  // å¤„ç†å“åº”
});
```

### 3. å…¼å®¹æ€§
`background_offscreen.js` åŒæ—¶æ”¯æŒ `type` å’Œ `action` å­—æ®µï¼š
```javascript
const messageType = request.type || request.action;
```

### 4. è¶…æ—¶å¤„ç†
æ¶ˆæ¯å¯èƒ½ä¼šè¶…æ—¶ï¼Œå»ºè®®æ·»åŠ è¶…æ—¶å¤„ç†ï¼š
```javascript
async sendMessageWithTimeout(message, timeout = 30000) {
  return Promise.race([
    this.sendMessage(message),
    new Promise((_, reject) => 
      setTimeout(() => reject(new Error('Timeout')), timeout)
    )
  ]);
}
```

---

## è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹ Service Worker æ—¥å¿—
```
chrome://extensions/ â†’ service worker â†’ Console
```

### 2. æŸ¥çœ‹ Popup æ—¥å¿—
```
å³é”®ç‚¹å‡»æ‰©å±•å›¾æ ‡ â†’ å®¡æŸ¥å¼¹å‡ºå†…å®¹ â†’ Console
```

### 3. æŸ¥çœ‹ Offscreen Document æ—¥å¿—
```
chrome://extensions/ â†’ 
åœ¨ Service Worker Console ä¸­æŸ¥æ‰¾ Offscreen Document çš„ iframe
```

### 4. æ·»åŠ è¯¦ç»†æ—¥å¿—
```javascript
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  console.log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯:', {
    type: request.type,
    from: sender.tab ? 'content' : 'popup',
    data: request
  });
  
  // ... å¤„ç†æ¶ˆæ¯
  
  console.log('ğŸ“¤ å‘é€å“åº”:', response);
  sendResponse(response);
});
```

---

## æ€»ç»“

âœ… æ‰€æœ‰æ¶ˆæ¯ç±»å‹å·²ç»Ÿä¸€  
âœ… Popup â†” Background é€šä¿¡æ­£å¸¸  
âœ… Background â†” Offscreen é€šä¿¡æ­£å¸¸  
âœ… æ”¯æŒå¼‚æ­¥å“åº”  
âœ… å®Œå–„çš„é”™è¯¯å¤„ç†  

**ç°åœ¨é‡æ–°åŠ è½½æ‰©å±•ï¼Œåº”è¯¥å¯ä»¥æ­£å¸¸æœç´¢äº†ï¼** ğŸ‰

